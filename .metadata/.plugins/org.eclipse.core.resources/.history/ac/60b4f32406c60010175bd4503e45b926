package com.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;
import com.repository.UserRepository;
import com.model.UserLoginRequest;
import com.util.JwtResponse;
import com.util.JwtUtili;

@RestController
public class AuthController {

    @Autowired
    private UserRepository userrepo;

    @Autowired
    private JwtUtili jwtutil;

    @Autowired
    private PasswordEncoder passwordEncoder;
    

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody UserLoginRequest loginRequest) {
    	System.out.println("user id is "+loginRequest.getUserid() );
        Optional<UserLoginRequest> user = userrepo.findByUserid(loginRequest.getUserid());
        String rawRole = user.get().getRole(); // e.g., "admin"
        String roleWithPrefix = rawRole.startsWith("ROLE_") ? rawRole : "ROLE_" + rawRole;
        String token = jwtutil.generateToken(user.get().getUserid(), List.of(roleWithPrefix));
        if (user.isPresent() && passwordEncoder.matches(loginRequest.getPassword(), user.get().getPassword())) {
    //        String token = jwtutil.generateToken(user.get().getUserid(), List.of(user.get().getRole()));
            return ResponseEntity.ok(new JwtResponse(token));
        } else {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid username or password");
        }
    }}